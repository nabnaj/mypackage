name: Tests  # Name of the workflow displayed in GitHub Actions

# ------------------------------------------------------------------
# ENVIRONMENT VARIABLES & CONFIGURATION
# ------------------------------------------------------------------
env:
  # Package configuration
  PACKAGE_NAME: 'mypackage'      # Your package name
  SOURCE_DIR: 'src'              # Directory containing source code
  TESTS_DIR: 'tests'             # Tests directory
  
  # Tool configuration
  USE_UV: 'false'                # Use pip for simplicity
  
  # Linting & analysis configuration
  FLAKE8_MAX_COMPLEXITY: '10'
  FLAKE8_ERROR_CODES: 'E9,F63,F7,F82'  # Critical error codes to fail on
  FLAKE8_EXCLUDE: '.venv,__pycache__,build,dist,*.egg-info'  # Exclude these directories
  
  # Security scanning configuration
  BANDIT_SKIP_TESTS: 'B101'      # Skip assert statements check (B101)

# ------------------------------------------------------------------
# TRIGGERS: When this workflow runs
# ------------------------------------------------------------------
on:
  push:  # Run on pushes to main/master
    branches: [ main, master ]
  pull_request:  # Run on PRs targeting main/master
    branches: [ main, master ]

# ------------------------------------------------------------------
# JOBS: The tasks to execute
# ------------------------------------------------------------------
jobs:
  test:
    # Run on the latest Ubuntu runner
    runs-on: ubuntu-latest
    
    # Strategy for matrix testing across Python versions
    strategy:
      matrix:
        # Define Python versions directly here (can't use env context)
        python-version: ["3.9", "3.10", "3.11", "3.12"]
      fail-fast: false  # Continue testing even if one version fails
    
    # ------------------------------------------------------------------
    # STEPS: Sequential tasks within the job
    # ------------------------------------------------------------------
    steps:
    
    # 1. Checkout the repository code
    - name: Checkout repository
      uses: actions/checkout@v3
    
    # 2. Set up the specified Python version
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'  # Enable pip caching
    
    # 3. Install package dependencies
    - name: Install dependencies
      run: |
        echo "=== Installing dependencies ==="
        python -m pip install --upgrade pip
        
        # Install package with dev dependencies
        pip install -e ".[dev]"
        
        # Install additional testing tools
        pip install pytest-cov bandit
        
        echo "=== Installed Packages ==="
        python -m pip list | grep -E "(pytest|cov|bandit|mypy|flake8)" || true
    
    # 4. Linting with flake8
    - name: Lint with flake8
      run: |
        echo "=== Running flake8 linting ==="
        
        # Lint source directory
        if [ -d "$SOURCE_DIR" ]; then
          echo "Linting source directory: $SOURCE_DIR"
          flake8 $SOURCE_DIR \
            --exclude=$FLAKE8_EXCLUDE \
            --max-complexity=$FLAKE8_MAX_COMPLEXITY \
            --count \
            --select=$FLAKE8_ERROR_CODES \
            --show-source \
            --statistics
        else
          echo "Warning: Source directory '$SOURCE_DIR' not found"
        fi
        
        # Lint tests directory
        if [ -d "$TESTS_DIR" ]; then
          echo "Linting tests directory: $TESTS_DIR"
          flake8 $TESTS_DIR \
            --exclude=$FLAKE8_EXCLUDE \
            --max-complexity=$FLAKE8_MAX_COMPLEXITY \
            --count \
            --exit-zero \
            --statistics
        fi
    
    # 5. Type checking with mypy
    - name: Type check with mypy
      run: |
        echo "=== Running mypy type checking ==="
        if [ -d "$SOURCE_DIR" ]; then
          mypy $SOURCE_DIR \
            --ignore-missing-imports \
            --show-error-codes \
            --pretty
        else
          echo "No source directory found, skipping mypy"
        fi
    
    # 6. Security scanning with bandit
    - name: Security scan with bandit
      run: |
        echo "=== Running bandit security scan ==="
        if [ -d "$SOURCE_DIR" ]; then
          bandit -r $SOURCE_DIR \
            --skip "$BANDIT_SKIP_TESTS" \
            -f txt \
            || echo "Bandit scan completed (warnings are okay)"
        else
          echo "No source directory found for security scan"
        fi
    
    # 7. Run tests with pytest - USING CONFIG FROM pyproject.toml
    - name: Test with pytest
      run: |
        echo "=== Running pytest ==="
        
        # Run tests as configured in pyproject.toml
        # Your addopts already has: -v --cov=mypackage --cov-report=term-missing
        # We just need to add XML coverage report for CI
        pytest --cov-report=xml
        
        # Show coverage summary
        if [ -f "coverage.xml" ]; then
          echo "=== Coverage Summary ==="
          python -m coverage report
        fi
    
    # 8. Upload coverage results to Codecov
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        fail_ci_if_error: false
        verbose: true
    
    # 9. Test summary
    - name: Generate Test Summary
      if: always()
      run: |
        echo "=== Test Summary ==="
        echo "✅ Python ${{ matrix.python-version }}"
        echo "✅ Package: $PACKAGE_NAME"
        echo "✅ Tests completed"
        
        if [ -f "coverage.xml" ]; then
          echo "✅ Coverage report generated"
        fi
        
        echo ""
        echo "Workflow status: ${{ job.status }}"