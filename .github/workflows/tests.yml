name: Tests  # Name of the workflow displayed in GitHub Actions

# ------------------------------------------------------------------
# ENVIRONMENT VARIABLES & CONFIGURATION
# ------------------------------------------------------------------
env:
  # Package configuration
  PACKAGE_NAME: 'mypackage'      # Change this to your actual package name
  SOURCE_DIR: 'src'              # Directory containing source code
  TESTS_DIR: '.'                 # Tests in current directory (adjust as needed)
  DEV_DEPENDENCIES: 'dev'        # Extra dependencies for development
  
  # Tool configuration
  USE_UV: 'true'                 # Set to 'false' to use pip instead of uv
  VENV_DIR: '.venv'              # Virtual environment directory
  
  # Linting & analysis configuration
  FLAKE8_MAX_COMPLEXITY: '10'
  FLAKE8_ERROR_CODES: 'E9,F63,F7,F82'  # Critical error codes to fail on
  FLAKE8_EXCLUDE: '.venv,__pycache__,build,dist,*.egg-info'  # Exclude these directories
  
  # Security scanning configuration
  BANDIT_SKIP_TESTS: 'B101'      # Skip assert statements check (B101)
  BANDIT_CONFIDENCE_LEVEL: 'high'  # Only report high confidence issues
  BANDIT_SEVERITY_LEVEL: 'medium'  # Report medium and high severity issues
  
  # Testing configuration
  COVERAGE_THRESHOLD: '0'        # Minimum coverage percentage (0 = no threshold)
  COVERAGE_REPORT: 'xml'         # Coverage report format
  PYTEST_ARGS: '-v --tb=short'   # Pytest arguments

# ------------------------------------------------------------------
# TRIGGERS: When this workflow runs
# ------------------------------------------------------------------
on:
  push:  # Run on pushes to main/master
    branches: [ main, master ]
  pull_request:  # Run on PRs targeting main/master
    branches: [ main, master ]

# ------------------------------------------------------------------
# JOBS: The tasks to execute
# ------------------------------------------------------------------
jobs:
  test:
    # Run on the latest Ubuntu runner
    runs-on: ubuntu-latest
    
    # Strategy for matrix testing across Python versions
    strategy:
      matrix:
        # Define Python versions directly here (can't use env context)
        python-version: ["3.9", "3.10", "3.11", "3.12"]
      fail-fast: false  # Continue testing even if one version fails
    
    # ------------------------------------------------------------------
    # STEPS: Sequential tasks within the job
    # ------------------------------------------------------------------
    steps:
    
    # 1. Checkout the repository code
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0  # Fetch all history for proper version tagging
    
    # 2. Set up the specified Python version
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    # 3. Fix pyproject.toml license format (temporary fix for CI)
    - name: Fix pyproject.toml for CI
      run: |
        # Fix the deprecated license format to avoid warnings
        sed -i 's/license = {text = "MIT"}/license = "MIT"/g' pyproject.toml
        echo "Fixed license format in pyproject.toml"
    
    # 4. Cache packages for faster builds
    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/pip
          ~/.cache/uv
          ${{ env.VENV_DIR }}
        key: ${{ runner.os }}-${{ matrix.python-version }}-${{ hashFiles('**/pyproject.toml', '**/setup.py', '**/requirements*.txt') }}
        restore-keys: |
          ${{ runner.os }}-${{ matrix.python-version }}-
          ${{ runner.os }}-
    
    # 5. Install package dependencies - SIMPLIFIED
    - name: Install dependencies
      run: |
        # Use pip instead of uv for now to avoid complexity
        echo "Using pip for dependency installation..."
        python -m pip install --upgrade pip setuptools wheel
        
        # Install package in development mode
        pip install -e ".[$DEV_DEPENDENCIES]"
        
        # Verify installations
        echo "=== Installed Packages ==="
        python -m pip list | grep -E "(pytest|cov|bandit|mypy|flake8)" || true
    
    # 6. Linting with flake8 - EXCLUDING VENV
    - name: Lint with flake8
      run: |
        echo "=== Running flake8 linting (excluding .venv) ==="
        
        # Build list of directories to lint
        LINT_DIRS=""
        
        # Add source directory if it exists
        if [ -d "$SOURCE_DIR" ]; then
          LINT_DIRS="$SOURCE_DIR"
          echo "Linting source directory: $SOURCE_DIR"
        else
          echo "No source directory found at '$SOURCE_DIR'"
        fi
        
        # Add tests directory if it exists and is not current directory
        if [ -d "$TESTS_DIR" ] && [ "$TESTS_DIR" != "." ]; then
          LINT_DIRS="$LINT_DIRS $TESTS_DIR"
          echo "Linting tests directory: $TESTS_DIR"
        elif [ -d "tests" ]; then
          LINT_DIRS="$LINT_DIRS tests"
          echo "Linting tests directory: tests"
        fi
        
        if [ -z "$LINT_DIRS" ]; then
          echo "No directories to lint, checking for Python files in current directory..."
          # Check if there are Python files in current directory
          if find . -maxdepth 1 -name "*.py" | grep -q "."; then
            LINT_DIRS="."
            echo "Linting current directory"
          else
            echo "No Python files found to lint"
            exit 0
          fi
        fi
        
        echo "Excluding: $FLAKE8_EXCLUDE"
        
        # Run flake8 with exclusions
        flake8 $LINT_DIRS \
          --exclude=$FLAKE8_EXCLUDE \
          --count \
          --select=$FLAKE8_ERROR_CODES \
          --show-source \
          --statistics \
          --max-complexity=$FLAKE8_MAX_COMPLEXITY
    
    # 7. Static type checking with mypy
    - name: Type check with mypy
      run: |
        echo "=== Running mypy type checking ==="
        if [ -d "$SOURCE_DIR" ]; then
          mypy $SOURCE_DIR \
            --ignore-missing-imports \
            --show-error-codes \
            --pretty
        else
          echo "No source directory found at '$SOURCE_DIR', skipping mypy"
        fi
    
    # 8. Security scanning with bandit
    - name: Security scan with bandit
      run: |
        echo "=== Running bandit security scan ==="
        # Determine source directory
        if [ -d "$SOURCE_DIR" ]; then
          SCAN_DIR="$SOURCE_DIR"
        else
          SCAN_DIR="."
          echo "Warning: Scanning current directory instead of '$SOURCE_DIR'"
        fi
        
        # Run bandit security scanner with basic output
        bandit \
          -r $SCAN_DIR \
          --skip "$BANDIT_SKIP_TESTS" \
          -f txt \
          || echo "Bandit scan completed (warnings are okay)"
    
    # 9. Run tests with pytest
    - name: Test with pytest
      run: |
        echo "=== Running pytest with coverage ==="
        
        # Determine where to run tests
        TEST_PATH="."
        if [ -d "tests" ]; then
          TEST_PATH="tests"
        elif [ -d "$TESTS_DIR" ] && [ "$TESTS_DIR" != "." ]; then
          TEST_PATH="$TESTS_DIR"
        fi
        
        echo "Running tests from: $TEST_PATH"
        
        # Run tests with coverage
        pytest \
          --cov=$PACKAGE_NAME \
          --cov-report=xml \
          --cov-report=term-missing \
          -v \
          $TEST_PATH
    
    # 10. Upload coverage results to Codecov
    - name: Upload coverage to Codecov
      if: ${{ always() }}
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        fail_ci_if_error: false
        verbose: true
    
    # 11. Test summary
    - name: Generate Test Summary
      if: always()
      run: |
        echo "# ðŸš€ CI/CD Test Summary"
        echo ""
        echo "## ðŸ“‹ Environment"
        echo "- Python Version: ${{ matrix.python-version }}"
        echo "- Runner: ${{ runner.os }}"
        echo "- Package: $PACKAGE_NAME"
        echo ""
        
        echo "## âœ… Checks Completed"
        echo "- Linting: Done (excluded .venv)"
        echo "- Type Checking: Done"
        echo "- Security Scan: Done"
        echo "- Tests: Done"
        echo "- Coverage: Generated"
        echo ""
        
        echo "## ðŸ“Š Coverage"
        if [ -f "coverage.xml" ]; then
          echo "Coverage report available for upload"
        else
          echo "No coverage report generated"
        fi
        
        echo ""
        echo "Workflow status: ${{ job.status }}"