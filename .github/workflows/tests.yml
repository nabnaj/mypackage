name: Tests  # Name of the workflow displayed in GitHub Actions

# ------------------------------------------------------------------
# ENVIRONMENT VARIABLES & CONFIGURATION
# ------------------------------------------------------------------
env:
  # Package configuration
  PACKAGE_NAME: 'mypackage'      # Change this to your actual package name
  SOURCE_DIR: 'src'              # Directory containing source code
  TESTS_DIR: '.'                 # Tests in current directory (adjust as needed)
  DEV_DEPENDENCIES: 'dev'        # Extra dependencies for development
  
  # Tool configuration
  USE_UV: 'true'                 # Set to 'false' to use pip instead of uv
  
  # Linting & analysis configuration
  FLAKE8_MAX_COMPLEXITY: '10'
  FLAKE8_ERROR_CODES: 'E9,F63,F7,F82'  # Critical error codes to fail on
  
  # Security scanning configuration
  BANDIT_SKIP_TESTS: 'B101'      # Skip assert statements check (B101)
  BANDIT_CONFIDENCE_LEVEL: 'high'  # Only report high confidence issues
  BANDIT_SEVERITY_LEVEL: 'medium'  # Report medium and high severity issues
  
  # Testing configuration
  COVERAGE_THRESHOLD: '0'        # Minimum coverage percentage (0 = no threshold)
  COVERAGE_REPORT: 'xml'         # Coverage report format
  PYTEST_ARGS: '-v --tb=short'   # Pytest arguments

# ------------------------------------------------------------------
# TRIGGERS: When this workflow runs
# ------------------------------------------------------------------
on:
  push:  # Run on pushes to main/master
    branches: [ main, master ]
  pull_request:  # Run on PRs targeting main/master
    branches: [ main, master ]

# ------------------------------------------------------------------
# JOBS: The tasks to execute
# ------------------------------------------------------------------
jobs:
  test:
    # Run on the latest Ubuntu runner
    runs-on: ubuntu-latest
    
    # Strategy for matrix testing across Python versions
    strategy:
      matrix:
        # Define Python versions directly here (can't use env context)
        python-version: ["3.9", "3.10", "3.11", "3.12"]
      fail-fast: false  # Continue testing even if one version fails
    
    # ------------------------------------------------------------------
    # STEPS: Sequential tasks within the job
    # ------------------------------------------------------------------
    steps:
    
    # 1. Checkout the repository code
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0  # Fetch all history for proper version tagging
    
    # 2. Set up the specified Python version
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    # 3. Install uv package manager (faster than pip) - OPTIONAL
    - name: Install uv package manager
      if: ${{ env.USE_UV == 'true' }}
      run: |
        # Install uv - a fast Python package installer and resolver
        curl -LsSf https://astral.sh/uv/install.sh | sh
        # Add uv to PATH for subsequent steps
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH
    
    # 4. Cache packages for faster builds
    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/pip
          ~/.cache/uv
          .venv
        key: ${{ runner.os }}-${{ matrix.python-version }}-${{ hashFiles('**/pyproject.toml', '**/setup.py', '**/requirements*.txt') }}
        restore-keys: |
          ${{ runner.os }}-${{ matrix.python-version }}-
          ${{ runner.os }}-
    
    # 5. Install package dependencies
    - name: Install dependencies
      run: |
        # Determine which package manager to use
        if [ "$USE_UV" = "true" ] && command -v uv &> /dev/null; then
          echo "Using uv for dependency installation..."
          # Install package with dev dependencies using uv
          uv pip install -e ".[$DEV_DEPENDENCIES]"
          # Ensure pytest-cov is installed (required for coverage)
          uv pip install pytest-cov bandit mypy flake8
        else
          echo "Using pip for dependency installation..."
          python -m pip install --upgrade pip
          # Install package with dev dependencies using pip
          pip install -e ".[$DEV_DEPENDENCIES]"
          # Ensure pytest-cov is installed (required for coverage)
          pip install pytest-cov bandit mypy flake8
        fi
        
        # Verify installations
        echo "=== Installed Packages ==="
        python -m pip list | grep -E "(pytest|cov|bandit|mypy|flake8)" || true
    
    # 6. Linting with flake8 (code style and quality)
    - name: Lint with flake8
      run: |
        echo "=== Running flake8 linting ==="
        # Check if source and test directories exist
        if [ -d "$SOURCE_DIR" ]; then
          SRC_DIRS="$SOURCE_DIR"
        else
          SRC_DIRS="."
          echo "Warning: SOURCE_DIR='$SOURCE_DIR' not found, using current directory"
        fi
        
        if [ -d "$TESTS_DIR" ] && [ "$TESTS_DIR" != "." ]; then
          TEST_DIRS="$TESTS_DIR"
        else
          TEST_DIRS="."
        fi
        
        # First check for critical errors (fails CI)
        flake8 $SRC_DIRS $TEST_DIRS \
          --count \
          --select=$FLAKE8_ERROR_CODES \
          --show-source \
          --statistics
        
        # Then check for style issues (doesn't fail CI)
        flake8 $SRC_DIRS $TEST_DIRS \
          --count \
          --exit-zero \
          --max-complexity=$FLAKE8_MAX_COMPLEXITY \
          --statistics
    
    # 7. Static type checking with mypy
    - name: Type check with mypy
      run: |
        echo "=== Running mypy type checking ==="
        if [ -d "$SOURCE_DIR" ]; then
          mypy $SOURCE_DIR \
            --ignore-missing-imports \
            --show-error-codes \
            --pretty
        else
          echo "No source directory found at '$SOURCE_DIR', skipping mypy"
        fi
    
    # 8. Security scanning with bandit - SIMPLIFIED VERSION
    - name: Security scan with bandit
      run: |
        echo "=== Running bandit security scan ==="
        # Determine source directory
        if [ -d "$SOURCE_DIR" ]; then
          SCAN_DIR="$SOURCE_DIR"
        else
          SCAN_DIR="."
          echo "Warning: Scanning current directory instead of '$SOURCE_DIR'"
        fi
        
        # Run bandit security scanner
        bandit \
          -r $SCAN_DIR \
          --skip "$BANDIT_SKIP_TESTS" \
          -ll "$BANDIT_CONFIDENCE_LEVEL" \
          -l "$BANDIT_SEVERITY_LEVEL" \
          -f json \
          -o bandit-report.json \
          || true  # Don't fail CI on bandit warnings
        
        echo "Bandit scan completed. Report saved to bandit-report.json"
        
        # Show simple summary without complex Python code
        if [ -f "bandit-report.json" ]; then
          echo "=== Bandit Scan Summary ==="
          # Use jq if available for JSON parsing
          if command -v jq &> /dev/null; then
            ISSUE_COUNT=$(jq '.results | length' bandit-report.json 2>/dev/null || echo "0")
            echo "Total issues found: $ISSUE_COUNT"
            if [ "$ISSUE_COUNT" -gt 0 ]; then
              echo "First few issues:"
              jq -r '.results[0:3][] | "  - " + .test_id + ": " + .issue_text[0:80] + "..."' bandit-report.json 2>/dev/null || true
            fi
          else
            # Fallback to grep if jq is not available
            ISSUE_COUNT=$(grep -c '"issue_text"' bandit-report.json 2>/dev/null || echo "0")
            echo "Total issues found: $ISSUE_COUNT"
          fi
        fi
    
    # 9. Run tests with pytest and generate coverage report
    - name: Test with pytest
      run: |
        echo "=== Running pytest with coverage ==="
        
        # Build coverage arguments
        COVERAGE_ARGS=""
        if python -c "import pytest_cov" 2>/dev/null; then
          echo "pytest-cov is installed, enabling coverage"
          COVERAGE_ARGS="--cov=$PACKAGE_NAME --cov-report=$COVERAGE_REPORT"
          if [ "$COVERAGE_THRESHOLD" != "0" ]; then
            COVERAGE_ARGS="$COVERAGE_ARGS --cov-fail-under=$COVERAGE_THRESHOLD"
          fi
        else
          echo "Warning: pytest-cov not installed, running tests without coverage"
        fi
        
        # Run tests
        echo "Running: pytest $COVERAGE_ARGS $PYTEST_ARGS $TESTS_DIR"
        pytest $COVERAGE_ARGS $PYTEST_ARGS $TESTS_DIR
        
        # Generate coverage report if available
        if [ -f "coverage.xml" ]; then
          echo "=== Coverage Report ==="
          python -m coverage report || echo "Could not generate coverage report"
        fi
    
    # 10. Upload coverage results to Codecov (if coverage.xml exists)
    - name: Upload coverage to Codecov
      if: ${{ always() && env.COVERAGE_REPORT == 'xml' }}
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        fail_ci_if_error: false  # Don't fail if upload fails
        verbose: true
    
    # 11. Comprehensive test summary
    - name: Generate Test Summary
      if: always()  # Always run this step for visibility
      run: |
        echo "# üöÄ CI/CD Test Summary"
        echo ""
        echo "## üìã Environment"
        echo "- Python Version: ${{ matrix.python-version }}"
        echo "- Runner: ${{ runner.os }}"
        echo "- Package Name: $PACKAGE_NAME"
        echo "- Source Directory: $SOURCE_DIR"
        echo "- Tests Directory: $TESTS_DIR"
        echo "- Package Manager: $USE_UV"
        echo ""
        
        echo "## üõ† Tools & Versions"
        echo '```'
        python --version
        python -m pip list | grep -E "(pytest|flake8|mypy|bandit|coverage)" || echo "Some tools not found"
        echo '```'
        echo ""
        
        echo "## üìä Test Results"
        echo ""
        
        # Check test results
        if [ -f ".coverage" ] || [ -f "coverage.xml" ]; then
          echo "‚úÖ Tests: Completed with coverage"
          if command -v python -m coverage &> /dev/null; then
            echo '```'
            python -m coverage report || echo "No coverage data available"
            echo '```'
          fi
        else
          echo "‚ö†Ô∏è Tests: No coverage data found"
        fi
        
        # Check linting results
        echo "‚úÖ Linting: Completed (see logs above)"
        
        # Check security scan
        if [ -f "bandit-report.json" ]; then
          # Simple check without Python parsing
          if grep -q '"issue_text"' bandit-report.json 2>/dev/null; then
            echo "‚ö†Ô∏è Security Scan: Issues found (see bandit-report.json)"
          else
            echo "‚úÖ Security Scan: No issues found"
          fi
        else
          echo "‚ö†Ô∏è Security Scan: No report generated"
        fi
        
        echo ""
        echo "## üìù Summary"
        echo "- $(date '+%Y-%m-%d %H:%M:%S')"
        echo "- Workflow: ${{ github.workflow }}"
        echo "- Run ID: ${{ github.run_id }}"
        echo ""
        
        # Final status message
        echo "## Status: ${{ job.status }}"